name: duplo-terraform

on:
  pull_request:
    paths:
      - 'stacks/**'
  workflow_dispatch:
    inputs:
      environment:
        description: Target Duplo tenant (maps to GH Environment)
        type: environment
        default: tenant1

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  BUCKET: mal-tfstate-nonprod
  DDB_TABLE: tf-locks-nonprod
  KMS_KEY_ID: arn:aws:kms:us-east-1:359100918503:key/8277ea5a-e952-4ed1-8ae7-31bc14e38195
  KEY_PREFIX: duplo-platform/nonprod

jobs:
  # Detect which stacks changed so we only run those
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      admin: ${{ steps.f.outputs.admin }}
      eks_admin: ${{ steps.f.outputs.eks_admin }}
      t1: ${{ steps.f.outputs.t1 }}
      t2: ${{ steps.f.outputs.t2 }}
      env_name: ${{ steps.envname.outputs.name }}
    steps:
      - uses: actions/checkout@v4
      - name: Determine environment name
        id: envname
        shell: bash
        run: |
          # use workflow_dispatch input if present; else default tenant1
          echo "name=${{ github.event.inputs.environment || 'tenant1' }}" >> $GITHUB_OUTPUT
      - uses: dorny/paths-filter@v3
        id: f
        with:
          filters: |
            admin:
              - 'stacks/admin-infra/**'
            eks_admin:
              - 'stacks/eks-nodes/admin/**'
            t1:
              - 'stacks/tenants/tenant1/**'
            t2:
              - 'stacks/tenants/tenant2/**'

  plan-apply:
    needs: detect-changes
    runs-on: ubuntu-latest
    # On PR: always run, but limit stacks via matrix. On manual: map to selected environment
    environment:
      name: ${{ needs.detect-changes.outputs.env_name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: admin-infra
            run_if: ${{ needs.detect-changes.outputs.admin == 'true' || github.event_name == 'workflow_dispatch' }}
            workdir: stacks/admin-infra
            key_suffix: admin-infra/terraform.tfstate
          - name: eks-nodes-admin
            run_if: ${{ needs.detect-changes.outputs.eks_admin == 'true' || github.event_name == 'workflow_dispatch' }}
            workdir: stacks/eks-nodes/admin
            key_suffix: eks-nodes/admin/terraform.tfstate
          - name: tenant1
            run_if: ${{ needs.detect-changes.outputs.t1 == 'true' || (github.event_name == 'workflow_dispatch' && needs.detect-changes.outputs.env_name == 'tenant1') }}
            workdir: stacks/tenants/tenant1
            key_suffix: tenants/tenant1/terraform.tfstate
          - name: tenant2
            run_if: ${{ needs.detect-changes.outputs.t2 == 'true' || (github.event_name == 'workflow_dispatch' && needs.detect-changes.outputs.env_name == 'tenant2') }}
            workdir: stacks/tenants/tenant2
            key_suffix: tenants/tenant2/terraform.tfstate

    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
      DUPLO_TENANT: ${{ needs.detect-changes.outputs.env_name }}

    steps:
      - uses: actions/checkout@v4

      # Short-circuit: skip steps when this matrix item isn't selected
      - name: Check matrix condition
        if: ${{ !matrix.run_if }}
        run: echo "Skipping ${{ matrix.name }}"; exit 0

      # Duplo CLI & (optional) JIT â€“ handy if you call duploctl, harmless if you don't
      - name: Duplo Setup
        uses: duplocloud/actions@v0.0.12
        with:
          mask-account-id: yes

      # AWS creds via OIDC (preferred for TF)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      # Backend init with your bucket/table/KMS and per-stack key
      - name: Terraform Init
        working-directory: ${{ matrix.workdir }}
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/${{ matrix.key_suffix }}"

      - name: Terraform Plan
        id: plan
        working-directory: ${{ matrix.workdir }}
        run: terraform plan -input=false -no-color -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.name }}
          path: ${{ matrix.workdir }}/tfplan

      # Apply only on main; gate via environment protection if you configured it
      - name: Terraform Apply (main only)
        if: github.ref == 'refs/heads/main'
        working-directory: ${{ matrix.workdir }}
        run: terraform apply -input=false -auto-approve tfplan