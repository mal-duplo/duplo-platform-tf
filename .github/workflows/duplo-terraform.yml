name: duplo-terraform

on:
  pull_request:
    paths:
      - 'stacks/admin-infra/**'
  workflow_dispatch:
    inputs:
      environment:
        description: Target Duplo tenant (also the GH Environment for approval)
        type: environment
        default: tenant1

permissions:
  id-token: write
  contents: read

concurrency:
  group: duplo-terraform-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  BUCKET: mal-tfstate-nonprod
  DDB_TABLE: tf-locks-nonprod
  KMS_KEY_ID: arn:aws:kms:us-east-1:359100918503:key/8277ea5a-e952-4ed1-8ae7-31bc14e38195
  KEY_PREFIX: duplo-platform/nonprod

jobs:
  # ---------- PR checks: fmt/validate only ----------
  pr-checks:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }
      - name: Terraform FMT (check)
        working-directory: stacks/admin-infra
        run: terraform fmt -check -diff -recursive
      - name: Terraform Init (local, no backend)
        working-directory: stacks/admin-infra
        run: terraform init -backend=false
      - name: Terraform Validate
        working-directory: stacks/admin-infra
        run: terraform validate

  # ---------- PLAN ----------
  plan:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.envname.outputs.name }}
    env:
      DUPLO_TOKEN:  ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:   ${{ vars.DUPLO_HOST }}
      # DUPLO_TENANT is not needed for admin-infra creation, but harmless if present.
      # DUPLO_TENANT: ${{ github.event.inputs.environment || 'tenant1' }}
    steps:
      - uses: actions/checkout@v4

      - id: envname
        run: echo "name=${{ github.event.inputs.environment || 'tenant1' }}" >> $GITHUB_OUTPUT

      - name: Duplo Setup
        uses: duplocloud/actions@v0.0.12
        with: { mask-account-id: yes }

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Make cidrinc scripts executable
        run: chmod +x stacks/admin-infra/cidrinc.sh || true

      - name: Terraform Init (remote backend)
        working-directory: stacks/admin-infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/admin-infra/terraform.tfstate"

      - name: Terraform Plan
        working-directory: stacks/admin-infra
        run: terraform plan -input=false -no-color -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-admin-infra
          path: stacks/admin-infra/tfplan

  # ---------- APPLY (manual approval via Environment) ----------
  apply:
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    needs: plan
    runs-on: ubuntu-latest
    # This is what will require manual approval before the job starts
    environment:
      name: ${{ needs.plan.outputs.env_name }}
    env:
      DUPLO_TOKEN:  ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:   ${{ vars.DUPLO_HOST }}
      # DUPLO_TENANT: ${{ needs.plan.outputs.env_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Duplo Setup
        uses: duplocloud/actions@v0.0.12
        with: { mask-account-id: yes }

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Make cidrinc scripts executable
        run: chmod +x stacks/admin-infra/cidrinc.sh || true

      - name: Terraform Init (remote backend)
        working-directory: stacks/admin-infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/admin-infra/terraform.tfstate"

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-admin-infra
          path: stacks/admin-infra

      - name: Terraform Apply (approved & main only)
        working-directory: stacks/admin-infra
        run: terraform apply -input=false -auto-approve tfplan