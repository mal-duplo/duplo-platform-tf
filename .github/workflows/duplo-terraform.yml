name: duplo-terraform

on:
  pull_request:
    paths: ['stacks/admin-infra/**']
  workflow_dispatch:
    inputs:
      environment:
        description: Target Duplo tenant (for GH Environment approval name)
        type: environment
        default: tenant1

permissions:
  id-token: write
  contents: read

concurrency:
  group: duplo-terraform-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  BUCKET: mal-tfstate-nonprod
  DDB_TABLE: tf-locks-nonprod
  KMS_KEY_ID: arn:aws:kms:us-east-1:359100918503:key/8277ea5a-e952-4ed1-8ae7-31bc14e38195
  KEY_PREFIX: duplo-platform/nonprod

jobs:
  # ---------- PR checks (fmt/validate only) ----------
  pr-checks:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }
      - name: Terraform FMT (check)
        working-directory: stacks/admin-infra
        run: terraform fmt -check -diff -recursive
      - name: Terraform Init (local, no backend)
        working-directory: stacks/admin-infra
        run: terraform init -backend=false
      - name: Terraform Validate
        working-directory: stacks/admin-infra
        run: terraform validate

  # ---------- PLAN: admin-infra ----------
  plan-admin:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.envname.outputs.name }}
    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
    steps:
      - uses: actions/checkout@v4

      - id: envname
        run: echo "name=${{ github.event.inputs.environment || 'tenant1' }}" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Make cidrinc executable
        run: chmod +x stacks/admin-infra/cidrinc.sh || true

      - name: Terraform Init (remote backend)
        working-directory: stacks/admin-infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/admin-infra/terraform.tfstate"

      - name: Terraform Plan (admin-infra)
        working-directory: stacks/admin-infra
        run: terraform plan -input=false -no-color -var-file="admin-infra.tfvars" -out=tfplan

      - uses: actions/upload-artifact@v4
        with:
          name: tfplan-admin-infra
          path: stacks/admin-infra/tfplan

  # ---------- APPLY: admin-infra (requires manual approval via Environment) ----------
  apply-admin:
    if: github.event_name != 'pull_request'
    needs: plan-admin
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.plan-admin.outputs.env_name }}
    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Terraform Init (remote backend)
        working-directory: stacks/admin-infra
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/admin-infra/terraform.tfstate"

      - uses: actions/download-artifact@v4
        with:
          name: tfplan-admin-infra
          path: stacks/admin-infra

      - name: Terraform Apply (admin-infra)
        working-directory: stacks/admin-infra
        run: terraform apply -input=false -auto-approve tfplan

  # ---------- PLAN: tenant1 (runs ONLY after admin-infra is APPLIED) ----------
  plan-tenant1:
    if: github.event_name != 'pull_request'
    needs: apply-admin
    runs-on: ubuntu-latest
    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Terraform Init (remote backend) - tenant1
        working-directory: stacks/tenants/tenant1
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/tenants/tenant1/terraform.tfstate"

      - name: Terraform Plan (tenant1)
        working-directory: stacks/tenants/tenant1
        run: terraform plan -input=false -no-color -var-file="tenant.tfvars" -out=tfplan

      - uses: actions/upload-artifact@v4
        with:
          name: tfplan-tenant1
          path: stacks/tenants/tenant1/tfplan

  # ---------- APPLY: tenant1 ----------
  apply-tenant1:
    if: github.event_name != 'pull_request'
    needs: plan-tenant1
    runs-on: ubuntu-latest
    # optionally gate by the same environment approval:
    environment:
      name: ${{ needs.plan-admin.outputs.env_name }}
    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Terraform Init (remote backend) - tenant1
        working-directory: stacks/tenants/tenant1
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/tenants/tenant1/terraform.tfstate"

      - uses: actions/download-artifact@v4
        with:
          name: tfplan-tenant1
          path: stacks/tenants/tenant1

      - name: Terraform Apply (tenant1)
        working-directory: stacks/tenants/tenant1
        run: terraform apply -input=false -auto-approve tfplan

  # ---------- PLAN: tenant2 (runs ONLY after admin-infra is APPLIED) ----------
  plan-tenant2:
    if: github.event_name != 'pull_request'
    needs: apply-tenant1
    runs-on: ubuntu-latest
    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Terraform Init (remote backend) - tenant2
        working-directory: stacks/tenants/tenant2
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/tenants/tenant2/terraform.tfstate"

      - name: Terraform Plan (tenant2)
        working-directory: stacks/tenants/tenant2
        run: terraform plan -input=false -no-color -var-file="tenant.tfvars" -out=tfplan

      - uses: actions/upload-artifact@v4
        with:
          name: tfplan-tenant2
          path: stacks/tenants/tenant2/tfplan

  # ---------- APPLY: tenant2 ----------
  apply-tenant2:
    if: github.event_name != 'pull_request'
    needs: plan-tenant2
    runs-on: ubuntu-latest
    # optionally gate by the same environment approval:
    environment:
      name: ${{ needs.plan-admin.outputs.env_name }}
    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Terraform Init (remote backend) - tenant2
        working-directory: stacks/tenants/tenant2
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/tenants/tenant2/terraform.tfstate"

      - uses: actions/download-artifact@v4
        with:
          name: tfplan-tenant2
          path: stacks/tenants/tenant2

      - name: Terraform Apply (tenant2)
        working-directory: stacks/tenants/tenant2
        run: terraform apply -input=false -auto-approve tfplan

  # ---------- PLAN: eks/tenant1 (runs ONLY after tenant1 is APPLIED) ----------
  plan-eks-tenant1:
    if: github.event_name != 'pull_request'
    needs: apply-tenant2
    runs-on: ubuntu-latest
    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Terraform Init (remote backend) - eks/tenant1
        working-directory: stacks/eks/tenant1
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/eks/tenant1/terraform.tfstate"

      - name: Terraform Plan (eks/tenant1)
        working-directory: stacks/eks/tenant1
        run: terraform plan -input=false -no-color -var-file="eks.tfvars" -out=tfplan

      - uses: actions/upload-artifact@v4
        with:
          name: tfplan-eks-tenant1
          path: stacks/eks/tenant1/tfplan

  # ---------- APPLY: eks/tenant1 ----------
  apply-eks-tenant1:
    if: github.event_name != 'pull_request'
    needs: plan-eks-tenant1
    runs-on: ubuntu-latest
    # optionally gate by the same Environment approval you used earlier:
    environment:
      name: ${{ needs.plan-admin.outputs.env_name }}
    env:
      DUPLO_TOKEN: ${{ secrets.DUPLO_TOKEN }}
      DUPLO_HOST:  ${{ vars.DUPLO_HOST }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::359100918503:role/github-oidc-terraform
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.6.6 }

      - name: Terraform Init (remote backend) - eks/tenant1
        working-directory: stacks/eks/tenant1
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${DDB_TABLE}" \
            -backend-config="encrypt=true" \
            -backend-config="kms_key_id=${KMS_KEY_ID}" \
            -backend-config="key=${KEY_PREFIX}/eks/tenant1/terraform.tfstate"

      - uses: actions/download-artifact@v4
        with:
          name: tfplan-eks-tenant1
          path: stacks/eks/tenant1

      - name: Terraform Apply (eks/tenant1)
        working-directory: stacks/eks/tenant1
        run: terraform apply -input=false -auto-approve tfplan